<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Sync folders with Python &#8211; Tadej's Blog</title>
<meta name="description" content="Manually comparing and synchronizing two folders can be tedious. Add long, confusing and very similar filenames and it's no fun at all. Here's how to automate the process with Python.">
<meta name="keywords" content="python, script, automation, folder-sync">



<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Sync folders with Python">
<meta property="og:description" content="Manually comparing and synchronizing two folders can be tedious. Add long, confusing and very similar filenames and it's no fun at all. Here's how to automate the process with Python.">
<meta property="og:url" content="/sync-folders-with-python/">
<meta property="og:site_name" content="Tadej's Blog">





<link rel="canonical" href="/sync-folders-with-python/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Tadej's Blog Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">



</head>

<body id="post" >

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->
<nav id="dl-menu" class="dl-menuwrapper" role="navigation">
    <button class="dl-trigger">Open Menu</button>

    <ul class="dl-menu">
        
        <li>
            <a href="/">Home</a>
        </li>

        <li>
            <a href="/about/">About</a>
        </li>

        <li>
            <a href="/posts/">Posts</a>
        </li>

        <li>
            <a href="/projects/">Projects</a>
        </li>

        
        <li>
            <a href="http://linkedin.com/in/tadejslamic"><i class="fa fa-fw fa-linkedin"></i> LinkedIn</a>
        </li>
        

        
        <li>
            <a href="http://github.com/tslamic"><i class="fa fa-fw fa-github"></i> GitHub</a>
        </li>
        
        
        
        <li>
            <a href="http://stackoverflow.com/users/905349/curtisloew"><i class="fa fa-fw fa-stack-exchange"></i> Stack Overflow</a>
        </li>
        

    </ul>
    
</nav>




<div id="main" role="main">
  <article class="hentry">
    <header class="header-title">
      <div class="header-title-wrap">
        
          <h1 class="entry-title"><a href="/sync-folders-with-python/" rel="bookmark" title="Sync folders with Python">Sync folders with Python</a></h1>
        
        <h2><span class="entry-date date published"><time datetime="2015-05-30T00:00:00-04:00">May 30, 2015</time></span></h2>
        
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
          Reading time ~14 minutes
        </p><!-- /.entry-reading-time -->
        
      </div><!-- /.header-title-wrap -->
    </header>
    <div class="entry-content">
      <p>Manually comparing and synchronizing two folders can be tedious. Add long, confusing and very similar filenames and it’s no fun at all.</p>

<figure class="center-align">
	<img src="http://throb.pagesperso-orange.fr/prg/Xojo/SyncTwoFolders_1024.png" title="sync-folders" width="300" height="300" />
	<figcaption>Source: throb.pagesperso-orange.fr</figcaption>
</figure>

<p>We recently faced a similar situation at work. Besides cryptic names, there was also a fair share of twisted logic governing the sync scenarios. We had to get our hands dirty, since the standard tools were useless.</p>

<p>Because we don’t have to do the sync often, and the folders have always been of reasonable size, automating the process seemed an overkill. However, as our products grow, so do the folders needing sync. We recently figured spending some time to create a script would be a good future investment.</p>

<p>This post builds upon ideas I came across writing the script, but were ultimately left out or done differently. It concludes with a simple tool capable of syncing two folders. The code was written using version 2.7.6.</p>

<h3 id="backing-and-reverting">Backing and reverting</h3>

<p>Let’s assume nothing is under version control. It would be cool if our script would have a revert mechanism of sorts, in case something funky happens during sync. To keep it simple, maybe a directory snapshot is enough:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">backup</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">ensure_dir_exists</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">REPO</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">REPO</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">REPO</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">sha</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
    <span class="n">archive_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">REPO</span><span class="p">,</span> <span class="n">sha</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">archive_path</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">make_archive</span><span class="p">(</span><span class="n">archive_path</span><span class="p">,</span> <span class="s">"zip"</span><span class="p">,</span> <span class="n">directory</span><span class="p">)</span>
    <span class="n">backup_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">BACKUP</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">backup_path</span><span class="p">,</span> <span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">b</span><span class="p">:</span>
        <span class="n">b</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sha</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">backup_path</span><span class="p">)</span> <span class="o">==</span> <span class="n">BACKUP_FILE_LENGTH</span>
    <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
        <span class="n">set_tag</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">archive_path</span> <span class="o">+</span> <span class="s">".zip"</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span></code></pre></div>

<p>It seems dense, but it’s easy to explain. First, we create a repository folder or <code>REPO</code>, if it doesn’t exist yet. It is where the backup snapshots live. We then save the archived directory under a unique name to <code>REPO</code>. Tag is optional, but if given, we’ll be able to reference the archived file with it. The name is written into <code>backup_path</code> and saved to <code>directory</code>. Let’s call it the <code>BACKUP</code> file. It’s there to help us revert:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">revert</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">archive_path</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">ensure_dir_exists</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">archive_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">archive_name</span> <span class="o">=</span> <span class="n">get_archive_name</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="n">archive_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">REPO</span><span class="p">,</span> <span class="n">archive_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">archive_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">CpException</span><span class="p">(</span><span class="s">"Archive '</span><span class="si">%</span><span class="s">s' missing."</span> <span class="o">%</span> <span class="n">archive_path</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">archive_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">zf</span><span class="p">:</span>
        <span class="n">zf</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></code></pre></div>

<p>In order to revert, we need to know the archived file to revert to. This is written in the <code>BACKUP</code> file which should be part of <code>directory</code>.</p>

<p><code>get_archive_name</code> helps us extract it:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">get_archive_name</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">backup_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">BACKUP</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">backup_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">CpException</span><span class="p">(</span><span class="s">"Backup file missing in '</span><span class="si">%</span><span class="s">s'."</span> <span class="o">%</span> <span class="n">directory</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">backup_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">b</span><span class="p">:</span>
        <span class="n">archive_name</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">ARCHIVE_NAME_REGEX</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">archive_name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">CpException</span><span class="p">(</span><span class="s">"Backup file in '</span><span class="si">%</span><span class="s">s' corrupted."</span> <span class="o">%</span> <span class="n">directory</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">archive_name</span> <span class="o">+</span> <span class="s">".zip"</span></code></pre></div>

<p>Note that any backed state is reachable by a sequence of reverts, as long as <code>REPO</code> contains the appropriate archive:</p>

<figure class="center-align">
	<img src="http://i.imgur.com/mIISsct.png" title="backup-revert" />
	<figcaption>Magenta arrows represent backups, green arrows reverts.</figcaption>
</figure>

<p>We should also be able to revert using tags. Here’s one way to do it:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">INSERT_TAG</span> <span class="o">=</span> <span class="s">"INSERT OR REPLACE INTO tags VALUES (?,?,?)"</span>
<span class="n">GET_TAG</span> <span class="o">=</span> <span class="s">"SELECT dir,zip FROM tags WHERE tag=?"</span>
<span class="n">CREATE_TAGS_TABLE</span> <span class="o">=</span> <span class="s">"""
CREATE TABLE IF NOT EXISTS tags (
    tag TEXT PRIMARY KEY,
    dir TEXT,
    zip TEXT
)
"""</span>


<span class="k">def</span> <span class="nf">set_tag</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">archive_path</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">tag</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">archive_path</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">TAGS</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">CREATE_TAGS_TABLE</span><span class="p">)</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">INSERT_TAG</span><span class="p">,</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">archive_path</span><span class="p">))</span>
        <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">revert_by_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">tag</span>
    <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">TAGS</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">GET_TAG</span><span class="p">,</span> <span class="p">(</span><span class="n">tag</span><span class="p">,))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CpException</span><span class="p">(</span><span class="s">"Tag '</span><span class="si">%</span><span class="s">s' does not exist."</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>
    <span class="n">directory</span><span class="p">,</span> <span class="n">archive_path</span> <span class="o">=</span> <span class="n">result</span>
    <span class="n">revert</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">archive_path</span><span class="p">)</span></code></pre></div>

<p>My initial thought was to serialize and de-serialize a dictionary, but performance would degrade quickly. Even with a bit of SQL, I’d argue the above is quite concise.</p>

<p>It’s also quite easy to show tag history of a directory:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">GET_DIR</span> <span class="o">=</span> <span class="s">"SELECT tag,zip FROM tags WHERE dir=?"</span>


<span class="k">def</span> <span class="nf">show_tag_history</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">TAGS</span><span class="p">)</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">GET_DIR</span><span class="p">,</span> <span class="p">(</span><span class="n">directory</span><span class="p">,))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CpException</span><span class="p">(</span><span class="s">"Directory '</span><span class="si">%</span><span class="s">s' has no backup history."</span> <span class="o">%</span> <span class="n">directory</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">tag</span><span class="p">,</span> <span class="n">archive_path</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">archive_path</span><span class="p">):</span>
            <span class="n">created</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">(</span><span class="n">archive_path</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">"TAG=</span><span class="si">%</span><span class="s">s, CREATED=</span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">created</span><span class="p">))</span></code></pre></div>

<p>There are a few things to consider when reverting:</p>

<ul>
  <li>we’re blindly extracting archives without prior inspection. It is possible that files are created outside of path, e.g. filenames starting with two dots. This could be a security hazard.</li>
  <li>someone could backup the root directory, then try to recover it and happily wipe out the hard drive, since we don’t worry about the directory we’re clearing.</li>
  <li>if the directory contains symbolic links, <code>shutil.rmtree(directory)</code> will throw an <code>OSError</code>.</li>
</ul>

<p>The issues are somewhat easily fixable and might be a good exercise to try out.</p>

<h3 id="finding-and-applying-the-differences">Finding and applying the differences</h3>

<p>Finding the differences between two directories couldn’t be simpler:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">find_diff</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">filecmp</span><span class="o">.</span><span class="n">dircmp</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
        <span class="n">diff_list</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">left_only</span> <span class="o">+</span> <span class="n">diff</span><span class="o">.</span><span class="n">diff_files</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">diff_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">src</span><span class="p">)]</span>
    <span class="n">ignore</span> <span class="o">=</span> <span class="p">(</span><span class="n">BACKUP</span><span class="p">,</span> <span class="n">SYNC</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ignore</span><span class="p">,</span> <span class="n">diff_list</span><span class="p">)</span></code></pre></div>

<p>If <code>dst</code> does not exist, then the difference is the <code>src</code> directory content. Otherwise, there’s a handy module we can use: <code>filecmp</code>. It contains a function <code>dircmp</code> that does exactly what we need - it finds all the differences between two folders.</p>

<p>We’re interested in files or folders only in <code>src</code>, or common files that differ. We also don’t want to copy any of the config files, so we filter them out.</p>

<p>This is how to apply the differences:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">apply_diff</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">diff_list</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">auto_backup</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">backup_tag</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">diff_list</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">diff_list</span> <span class="o">=</span> <span class="n">find_diff</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">diff_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">auto_backup</span><span class="p">:</span>
            <span class="n">backup</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">backup_tag</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">diff_list</span><span class="p">:</span>
            <span class="n">src_item</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="n">dst_item</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">src_item</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">src_item</span><span class="p">,</span> <span class="n">dst_item</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">src_item</span><span class="p">,</span> <span class="n">dst_item</span><span class="p">)</span></code></pre></div>

<p>The code speaks for itself. The point to note is the backup we perform before any copying is done. This enables us to revert if something goes sour.</p>

<h3 id="syncing-the-same-folders-over-and-over-and-over">Syncing the same folders over and over and over…</h3>

<p>Sometimes, you know beforehand the folders you need to sync. For example, you know that folder <code>A</code> will always have to be synced with folders <code>B</code> and  <code>C</code>. This is where <code>SYNC</code> file comes into play. It contains one or more source folders, each listed on a separate line.</p>

<p>In the example above, folder <code>A</code> should contain the <code>SYNC</code> file with the following content:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">/an/absolute/path/to/B
/an/absolute/path/to/C</code></pre></div>

<p>Then, all we need to do is sync the directory containing the <code>SYNC</code> file:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">sync</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">backup_tag</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">ensure_dir_exists</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">sync_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">SYNC</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">sync_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">CpException</span><span class="p">(</span><span class="s">"Sync file for '</span><span class="si">%</span><span class="s">s' missing."</span> <span class="o">%</span> <span class="n">directory</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sync_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">src_list</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">src_list</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CpException</span><span class="p">(</span><span class="s">"Sync file is empty."</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">src_list</span><span class="p">:</span>
        <span class="n">ensure_dir_exists</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s">"Invalid source dir: '</span><span class="si">%</span><span class="s">s'."</span> <span class="o">%</span> <span class="n">src</span><span class="p">)</span>
    <span class="n">backup</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">backup_tag</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">src_list</span><span class="p">:</span>
        <span class="n">apply_diff</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">auto_backup</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">backup_tag</span><span class="o">=</span><span class="n">backup_tag</span><span class="p">)</span></code></pre></div>

<p>As you can see, it’s as straightforward as opening the <code>SYNC</code> file, reading the sources, and then applying the differences.</p>

<p>Of course, we should provide means to generate such file:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">generate_sync_file</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">sources</span><span class="p">):</span>
    <span class="n">ensure_dir_exists</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">absolute_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">]</span>
    <span class="n">sync_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">SYNC</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sync_file</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">cp</span><span class="p">:</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">absolute_paths</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">sync_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span></code></pre></div>

<h3 id="adding-cli">Adding CLI</h3>

<p>To wrap what we’ve done in a simple utility tool, we should create a command line interface, so the user can interact with it. <code>argparse</code> module makes this simple. Before turning to code, here’s what the user should be able to do:</p>

<h4 id="copy-different-files-from-one-directory-to-another">1. Copy different files from one directory to another</h4>

<p>Example usage: <code>cp -t sample_tag /source/path/dir /destination/path/dir</code></p>

<p>The comand requires a <code>src</code> directory and a <code>dst</code> directory, where <code>dst</code> will be synced with <code>src</code>. Tag is optional.</p>

<h4 id="revert-a-directory-or-tag">2. Revert a directory or tag</h4>

<p>Example usage: <code>rv -t sample_tag</code> or <code>rv -d /random/path/dir</code></p>

<h4 id="sync-a-directory">3. Sync a directory</h4>

<p>Example usage: <code>sync -t just_in_case /random/dir/path</code></p>

<p><code>/random/dir/path</code> should contain the <code>SYNC</code> file. Tag is optional.</p>

<h4 id="create-a-sync-file">4. Create a <code>SYNC</code> file</h4>

<p>Example usage: <code>mksync dir/path/where/sync/is/created /fst/src /snd/src /trd/src</code></p>

<p>Create a <code>SYNC</code> file in the first specified directory. Any directory listed afterwards is added to the source list.</p>

<h4 id="show-tag-history">5. Show tag history</h4>

<p>Example usage: <code>th /random/dir/path</code></p>

<p>It shows the available revert tags.</p>

<p>Here’s the above in code:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">diff_parser</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s">"Compare and copy missing files from one dir to another"</span>
    <span class="p">)</span>

    <span class="n">subparsers</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_subparsers</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">"Options"</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">"opt"</span><span class="p">)</span>
    <span class="n">tag_parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">add_help</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">tag_parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-t"</span><span class="p">,</span> <span class="s">"--tag"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Backup tag"</span><span class="p">)</span>

    <span class="n">cp</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">"cp"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Copy from one dir to another"</span><span class="p">,</span>
                               <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">tag_parser</span><span class="p">])</span>
    <span class="n">cp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"src"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"source dir"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">ValidDirAction</span><span class="p">)</span>
    <span class="n">cp</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"dst"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"destination dir"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">ValidDirAction</span><span class="p">)</span>

    <span class="n">rv</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">"rv"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Revert"</span><span class="p">)</span>
    <span class="n">rv</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-d"</span><span class="p">,</span> <span class="s">"--dir"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"dir to revert"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">ValidDirAction</span><span class="p">)</span>
    <span class="n">rv</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"-t"</span><span class="p">,</span> <span class="s">"--tag"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"tag to revert"</span><span class="p">)</span>

    <span class="n">sync</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">"sync"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Auto-sync"</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">tag_parser</span><span class="p">])</span>
    <span class="n">sync</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"dir"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"dir to sync"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">ValidDirAction</span><span class="p">)</span>

    <span class="n">mksync</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">"mksync"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Generate auto-sync folder"</span><span class="p">)</span>
    <span class="n">mksync</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"dir"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"dir to auto-sync"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">ValidDirAction</span><span class="p">)</span>
    <span class="n">mksync</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"src"</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s">'+'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"source dirs"</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="n">ValidDirAction</span><span class="p">)</span>

    <span class="n">history</span> <span class="o">=</span> <span class="n">subparsers</span><span class="o">.</span><span class="n">add_parser</span><span class="p">(</span><span class="s">"th"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"Tag history"</span><span class="p">)</span>
    <span class="n">history</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">"dir"</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">"dir to check"</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">ValidDirAction</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parser</span></code></pre></div>

<p>Perhaps the only interesting thing in our parser is the custom action:</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">ValidDirAction</span><span class="p">(</span><span class="n">argparse</span><span class="o">.</span><span class="n">Action</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">namespace</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">option_string</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">directories</span> <span class="o">=</span> <span class="n">values</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="p">[</span><span class="n">values</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">directories</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">"Invalid dir: </span><span class="si">%</span><span class="s">s"</span> <span class="o">%</span> <span class="n">d</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">namespace</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dest</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span></code></pre></div>

<p>It ensures that any path we provide as an argument is an existing directory we can write to.</p>

<h3 id="fin">Fin</h3>

<p>We can now sync two folders and revert if need be. The tool is very simple and only offers crude functionality, but it’s a good starting point to build upon. What always amazes me is the expressiveness of Python and what can be achieved with
cca. 200 lines of code, half of which are paranoid asserts and param checks.</p>

<p>I’d also like to note that although I love Python, I don’t use it enough to consider myself a <em>pythonista</em>. If you spot any piece of code that can be replaced with a more standarized idiom, please let me know!</p>

<p>As always, there’s a <a href="https://github.com/tslamic/cptool">GitHub repo</a> where you can find the complete script.</p>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="/tags/#python" title="Pages tagged python" class="tag"><span class="term">python</span></a><a href="/tags/#script" title="Pages tagged script" class="tag"><span class="term">script</span></a><a href="/tags/#automation" title="Pages tagged automation" class="tag"><span class="term">automation</span></a><a href="/tags/#folder-sync" title="Pages tagged folder-sync" class="tag"><span class="term">folder-sync</span></a></span>
        
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=/sync-folders-with-python/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=/sync-folders-with-python/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=/sync-folders-with-python/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->
      </footer>
    </div><!-- /.entry-content -->
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="/android-menu-icon/" class="read-more-btn">Read More</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="/builders-and-required-params/" title="Builders and required params">Builders and required params</a></h3>
      <p>How to handle builders with required parameters <a href="/builders-and-required-params/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="/creating-android-device-names/" title="Creating AndroidDeviceNames">Creating AndroidDeviceNames</a></h4>
        <span>Published on August 22, 2015</span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="/android-menu-icon/" title="Android menu icon, delightfully">Android menu icon, delightfully</a></h4>
        <span>Published on April 11, 2015</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2017 Tadej Slamic. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="http://mademistakes.com/hpstr/" rel="notfollow">HPSTR Theme</a>.</span>
  </footer>
</div><!-- /.footer-wrapper -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>


<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44812127-1', 'auto');  
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>



    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'tslamic'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
	        

</body>
</html>
